"use strict";(self.webpackChunkjupyterlab_myst=self.webpackChunkjupyterlab_myst||[]).push([[1856,4692],{51856:(e,t,r)=>{r.r(t),r.d(t,{default:()=>se});var n=r(18875),s=r(19498),o=r(11919),a=r(32850),i=r(89993),d=r(44304);const l="user_expressions";function c(e){var t;return e.model.getMetadata?e.model.getMetadata(l):null===(t=e.model.metadata)||void 0===t?void 0:t.get(l)}var u=r(74901),m=r(97883),h=r(5350),g=r(976),f=r(14469),p=r(66029),v=r.n(p);const y=(0,p.createContext)(void 0);function x({expressions:e,rendermime:t,trusted:r,children:n}){return v().createElement(y.Provider,{value:{expressions:e,rendermime:t,trusted:r}},n)}const b=(0,p.createContext)(void 0);function k({controller:e,children:t}){return v().createElement(b.Provider,{value:{controller:e}},t)}var w=r(80757),_=r(18778);class E extends _.Widget{constructor(){super(),this.addClass("myst-RenderedExpressionError")}}class M extends _.Widget{constructor(e){super(),this.trusted=e.trusted,this.expression=e.expression,this.rendermime=e.rendermime,this.safe=e.safe,this.addClass("myst-RenderedExpression"),(this.layout=new _.SingletonLayout).widget=new E}renderExpression(e){const t=this.layout;if(!t)return console.error("Our layout is already disposed!!"),Promise.resolve();if(this.isDisposed)return console.error("Our layout is already disposed!!"),Promise.resolve();let r;r="ok"===e.status?{trusted:this.trusted,data:e.data,metadata:e.metadata}:{data:{"application/vnd.jupyter.stderr":e.traceback.join("\n")||`${e.ename}: ${e.evalue}`}};const n=this.rendermime.createModel(r),s=this.rendermime.preferredMimeType(n.data,this.safe);if(void 0===s)return console.error("Couldn't find mimetype for ",n),t.widget=new E,Promise.resolve();const o=this.rendermime.createRenderer(s);return t.widget=o,console.assert(o.isAttached,"renderer was not attached!",o),o.renderModel(n)}}function C({content:e}){return e=e.replace(/^(["'])(.*)\1$/,"$2"),v().createElement("span",null,e)}function R({error:e}){return v().createElement("span",{className:"text-black p-2","data-mime-type":"application/vnd.jupyter.stderr",style:{backgroundColor:"var(--jp-rendermime-error-background, #F9DEDE)",fontFamily:"var(--jp-code-font-family, monospace)",fontSize:"var(--jp-code-font-size)"}},v().createElement("span",{className:"text-[#e75c58]"},e.ename),": ",e.evalue)}function T({rendermime:e,trusted:t,expressionMetadata:r}){const n=(0,p.useRef)(null),[s,o]=(0,p.useState)(void 0);return(0,p.useEffect)((()=>{console.debug(`Creating inline renderer for  \`${r.expression}\``);const n=new M({expression:r.expression,trusted:t,rendermime:e,safe:"any"});return o(n),()=>{n.isAttached&&!n.node.isConnected?console.error(`Could not dispose of renderer for \`${r.expression}\`: node is not connected`):n.dispose()}}),[e,r]),(0,p.useEffect)((()=>{const e=s;if(n.current&&e)return e.isAttached&&console.error(`Expression renderer for \`${r.expression}\` is already attached to another node`),_.Widget.attach(e,n.current),console.debug(`Attached expression renderer for \`${r.expression}\` to parent widget`),()=>{e.isAttached&&!e.node.isConnected?console.error(`Unable to detach expression renderer for \`${r.expression}\`: node is not connected`):e.isAttached&&(console.debug(`Detaching expression renderer for \`${r.expression}\``),_.Widget.detach(e))};console.debug(`Cannot attach expression renderer for \`${r.expression}\``)}),[n,s]),(0,p.useEffect)((()=>{s&&r?s.renderExpression(r.result):console.debug(`Cannot render expression \`${r.expression}\``)}),[s,r]),console.debug(`Rendering MIME bundle for expression: '${r.expression}'`),v().createElement("div",{ref:n,className:"not-prose inline-block"})}function P({value:e}){const{expressions:t,rendermime:r,trusted:n}=null!==(s=(0,p.useContext)(y))&&void 0!==s?s:{};var s;if(!t||!r)return v().createElement("code",null,e);const o=null==t?void 0:t.find((t=>t.expression===e)),a=null==o?void 0:o.result.data;return console.debug(`Rendering \`${e}\` inline ${n?"with":"without"} trust`),o?(console.debug(`Using MIME bundle for \`${e}\``,a),"text/plain"===r.preferredMimeType(null!=a?a:{},n?"any":"ensure")?v().createElement(C,{content:null==a?void 0:a["text/plain"]}):"error"===o.result.status?(console.debug("Error for",e,o.result),v().createElement(R,{error:o.result})):v().createElement(T,{rendermime:r,trusted:!!n,expressionMetadata:o})):(console.debug("No metadata for",e),v().createElement("code",null,e))}function S({checked:e,line:t,children:r}){const[n,s]=v().useState(null!=e&&e),{controller:o}=null!==(a=(0,p.useContext)(b))&&void 0!==a?a:{};var a;return v().createElement("li",{className:"task-list-item"},v().createElement("input",{type:"checkbox",disabled:!o,className:"task-list-item-checkbox",checked:n,onClick:()=>{o&&null!=t&&(o({line:t,checked:!n}),s(!n))}}),r)}const D={...f.DEFAULT_RENDERERS,mermaid:w.MermaidNodeRenderer,inlineExpression:e=>v().createElement(P,{value:e.value}),listItem:(e,t)=>{var r;return null==e.checked?v().createElement("li",{key:e.key},t):v().createElement(S,{key:e.key,checked:e.checked,line:null===(r=e.position)||void 0===r?void 0:r.start.line},t)}};var A=r(22722),F=r(18378);async function I(e,t){const r=(0,A.td)("link,linkBlock",e);await Promise.all(r.map((async e=>{if(!e||!e.url)return;const r=t.resolver,n=e.url;if((0,F.updateLinkTextIfEmpty)(e,n),((null==r?void 0:r.isLocal)?r.isLocal(n):i.URLExt.isLocal(n))&&r)if(e.static){const t=await r.resolveUrl(n),s=await r.getDownloadUrl(t);e.urlSource=n,e.url=s}else e.internal=!0})))}class $ extends h.VDomModel{get references(){return this._references}set references(e){this._references=e,this.stateChanged.emit()}get mdast(){return this._mdast}set mdast(e){this._mdast=e,this.stateChanged.emit()}get expressions(){return this._expressions}set expressions(e){this._expressions=e,this.stateChanged.emit()}get frontmatter(){return this._frontmatter}set frontmatter(e){this._frontmatter=e,this.stateChanged.emit()}}class j extends h.VDomRenderer{constructor(e){const{model:t,resolver:r,linkHandler:n,rendermime:s,trusted:o}=e;super(t),this._trusted=!1,this._taskItemChanged=new u.Signal(this),this._resolver=r,this._linkHandler=n,this._rendermime=s,this._trusted=o,this.addClass("myst"),this._taskItemController=e=>this._taskItemChanged.emit(e)}get taskItemChanged(){return this._taskItemChanged}get trusted(){return this._trusted}set trusted(e){this._trusted=e,this.update()}render(){if(console.debug("Re-rendering VDOM for MySTWidget",this.model,this._trusted),!this.model)return v().createElement("span",null,"MyST Renderer!");const{references:e,frontmatter:t,mdast:r,expressions:n}=this.model,s=(0,f.useParse)(r||null,D);return v().createElement(k,{controller:this._taskItemController},v().createElement(g.ThemeProvider,{theme:"undefined"==typeof document?g.Theme.light:"false"===document.body.dataset.jpThemeLight?g.Theme.dark:g.Theme.light,Link:(o=this._resolver,a=this._linkHandler,e=>{const t=v().useRef(null),{to:r}=e;return v().useEffect((()=>{t&&t.current&&o&&async function(e,t,r){let n=e.getAttribute("href")||"";const s=t.isLocal?t.isLocal(n):i.URLExt.isLocal(n);if(!n||!s)return;const o=e.hash;if(o){if(o===n)return void(e.target="_self");n=n.replace(o,"")}try{const s=await t.resolveUrl(n),a=decodeURIComponent(s);r&&r.handleLink(e,a,o);const i=await t.getDownloadUrl(s);e.href=i+o}catch(t){e.href=""}}(t.current,o,a)}),[t,r]),v().createElement("a",{href:r,ref:t,className:e.className},e.children)}),renderers:D},v().createElement(x,{expressions:n,rendermime:this._rendermime,trusted:this._trusted},v().createElement(g.TabStateProvider,null,v().createElement(g.ReferencesProvider,{references:e,frontmatter:t},t&&v().createElement(m.FrontmatterBlock,{frontmatter:t}),s)))));var o,a}}var N=r(26150),L=r(7608),U=r(58579),W=r(41775),H=r(21243),q=r(11949),O=r(1588),B=r(61773),J=r(81507),z=r(13137);async function V(e,t){const r=t.resolver;if(!r)return;const n=(0,A.td)("image",e);await Promise.all(n.map((async e=>{if(!e||!e.url)return;const t=await r.resolveUrl(e.url);if(!t)return;const n=await r.getDownloadUrl(t);n&&(e.url=n)})))}const G=()=>e=>{!async function(e){(0,A.td)("cite",e).forEach((async e=>{e.children&&e.children.length>0||(e.error=!0,e.children=[{type:"text",value:e.label}])}))}(e)},K={name:"eval",body:{type:r(44692).Ft.string,required:!0},run:e=>[{type:"inlineExpression",value:e.body}]};function Y(e){const t=(0,N.mystParse)(e,{directives:[q.cardDirective,O.gridDirective,J.proofDirective,...B.tabDirectives,...z.exerciseDirectives],roles:[K]});return(0,U.l)().use(F.basicTransformationsPlugin).use(F.htmlPlugin,{htmlHandlers:{comment(e,t){const r=e(t,"comment");return r.value=t.value,r}}}).runSync(t),t}function Q(e){return"markdown"===e.model.type}class X extends a.MarkdownCell{constructor(e){var t,r;super(e),this._metadataJustChanged=!1,this._notebookRendermime=e.rendermime,this._attachmentsResolver=new d.AttachmentsResolver({parent:null!==(t=e.rendermime.resolver)&&void 0!==t?t:void 0,model:this.model.attachments}),this._mystModel=new $,this._mystWidget=new j({model:this._mystModel,rendermime:this._notebookRendermime,linkHandler:null!==(r=this._notebookRendermime.linkHandler)&&void 0!==r?r:void 0,resolver:this._attachmentsResolver,trusted:this.model.trusted}),this._mystWidget.taskItemChanged.connect(((e,t)=>this.setTaskItem(e,t))),this._renderer.dispose(),this._renderer=this._notebookRendermime.createRenderer("text/plain"),this.model.onTrustedChanged=()=>this.onModelTrustedChanged(),this._monitor.dispose(),this._monitor=this.createActivityMonitor(),this._handleRendered=this.onRenderedChanged,this.restoreExpressionsFromMetadata()}setTaskItem(e,t){const r=this.model.sharedModel.getSource().split("\n");r[t.line]=r[t.line].replace(/^(\s*(?:-|\*)\s*)(\[[\s|x]\])/,t.checked?"$1[x]":"$1[ ]"),this.model.sharedModel.setSource(r.join("\n"))}async onRenderedChanged(){if(this.rendered){if(this.placeholder)return void await this.updateFragmentMDAST();this.rendered&&await this.render()}else this.showEditor()}createActivityMonitor(){const e=new i.ActivityMonitor({signal:this.model.contentChanged,timeout:100});return this.ready.then((()=>{this.isDisposed||(console.debug("ready and connected activityStopped signal"),e.activityStopped.connect((()=>{console.debug("Activity monitor expired"),this.rendered&&!this._metadataJustChanged&&(console.debug("Updating cell!"),this.update()),this._metadataJustChanged=!1}),this))})).catch((e=>{console.error("Failed to be ready",e)})),e}restoreExpressionsFromMetadata(){const e=c(this);void 0!==e&&(console.debug("Restoring expressions from metadata",e),this._mystWidget.model.expressions=e)}onModelTrustedChanged(){console.debug("trust changed",this.model.trusted),this._mystWidget.trusted=this.model.trusted,this.restoreExpressionsFromMetadata()}onMetadataChanged(e,t){console.debug("metadata changed",t),this._metadataJustChanged=!0,t.key===l?(console.debug("metadata changed",t),this.restoreExpressionsFromMetadata()):super.onMetadataChanged(e,t)}get attachmentsResolver(){return this._attachmentsResolver}get mystModel(){return this._mystModel}set mystModel(e){e!==this._mystModel&&this._mystModel.dispose(),this._mystModel=e,this._mystWidget.model=e}get fragmentMDAST(){return this._fragmentMDAST}async updateFragmentMDAST(){let e=Y(this.model.sharedModel.getSource());this._attachmentsResolver&&(e=await async function(e,t){t=(0,L.Bc)(t);try{await V(t,{resolver:e})}catch(e){}return t}(this._attachmentsResolver,e)),e.type="block",this._fragmentMDAST=e}async render(){await this.updateFragmentMDAST(),this._mystWidget.node&&this.isAttached&&(await async function(e){var t;const r=e.widgets.filter(Q).filter((e=>void 0!==e.fragmentMDAST)),n=function(e){return{type:"root",children:e.map((e=>(0,L.Bc)(e.fragmentMDAST)))}}(r),{references:s,frontmatter:o,mdast:a}=await async function(e,t){var r;const n=[new F.WikiTransformer,new F.GithubTransformer,new F.DOITransformer,new F.RRIDTransformer],s=new W.k,o={cite:{order:[],data:{}},article:e},{frontmatter:a}=(0,F.getFrontmatter)(e.children[0],{removeYaml:!0,removeHeading:!0}),i=(0,H.validatePageFrontmatter)(a,{property:"frontmatter",messages:{}}),d=new F.ReferenceState({numbering:i.numbering,file:s});return(0,U.l)().use(F.mathPlugin,{macros:null!==(r=null==i?void 0:i.math)&&void 0!==r?r:{}}).use(F.glossaryPlugin,{state:d}).use(F.abbreviationPlugin,{abbreviations:i.abbreviations}).use(F.enumerateTargetsPlugin,{state:d}).use(F.linksPlugin,{transformers:n}).use(F.footnotesPlugin).use(F.resolveReferencesPlugin,{state:d}).use(G).use(F.keysPlugin).runSync(e,s),await I(e,{resolver:t}),s.messages.length>0&&console.error(s.messages.map((e=>e.message)).join("\n")),{references:o,frontmatter:i,mdast:e}}(n,null!==(t=e.rendermime.resolver)&&void 0!==t?t:void 0);r.forEach(((e,t)=>{if(e.rendered){const r=new $;r.references=s,r.frontmatter=0===t?o:void 0,r.mdast=a.children[t],r.expressions=e.mystModel.expressions,e.mystModel=r}}))}(this.parent),await this._mystWidget.renderPromise,this.inputArea.renderInput(this._mystWidget))}}class Z extends o.NotebookPanel.ContentFactory{createMarkdownCell(e){return e.contentFactory||(e.contentFactory=this),new X(e).initializeState()}}var ee=r(14470);const te="text/markdown";class re extends j{constructor(e){var t,r,n;super({model:void 0,resolver:null!==(t=e.resolver)&&void 0!==t?t:void 0,linkHandler:null!==(r=e.linkHandler)&&void 0!==r?r:void 0}),this.resolver=null!==(n=e.resolver)&&void 0!==n?n:void 0,this.node.dataset.mimeType=te,this.addClass("jp-RenderedMySTMarkdown")}async renderModel(e){if(window.trigger)throw Error("triggered!");const t=Y(e.data[te]),{references:r,mdast:n,frontmatter:s}=await async function(e,t){var r;e=(0,L.Bc)(e);const n=[new F.WikiTransformer,new F.GithubTransformer,new F.DOITransformer,new F.RRIDTransformer],s=new W.k,o={cite:{order:[],data:{}},article:e},{frontmatter:a}=(0,F.getFrontmatter)(e,{removeYaml:!0,removeHeading:!0}),i=(0,H.validatePageFrontmatter)(a,{property:"frontmatter",messages:{}}),d=new F.ReferenceState({numbering:i.numbering,file:s});return(0,U.l)().use(F.mathPlugin,{macros:null!==(r=null==i?void 0:i.math)&&void 0!==r?r:{}}).use(F.glossaryPlugin,{state:d}).use(F.abbreviationPlugin,{abbreviations:i.abbreviations}).use(F.enumerateTargetsPlugin,{state:d}).use(F.linksPlugin,{transformers:n}).use(F.footnotesPlugin).use(F.resolveReferencesPlugin,{state:d}).use(G).use(F.keysPlugin).runSync(e,s),await I(e,{resolver:t}),await V(e,{resolver:t}),{references:o,frontmatter:i,mdast:e}}(t,this.resolver),o=new $;return o.references=r,o.mdast=n,o.frontmatter=s,this.model&&(o.expressions=this.model.expressions),this.model=o,console.debug("State changed",this),this.renderPromise||Promise.resolve()}}const ne={safe:!0,mimeTypes:["text/markdown"],defaultRank:50,createRenderer:e=>new re(e)},se=[{id:"jupyterlab-myst:content-factory",provides:o.NotebookPanel.IContentFactory,requires:[s.IEditorServices],autoStart:!0,activate:(e,t)=>{console.log("JupyterLab extension jupyterlab-myst is activated!");const r=t.factoryService.newInlineEditor;return new Z({editorFactory:r})}},{id:"jupyterlab-myst:executor",requires:[o.INotebookTracker],autoStart:!0,activate:(e,t)=>{console.log("Using jupyterlab-myst:executor"),o.NotebookActions.executed.connect((async(e,r)=>{const{notebook:n,cell:s}=r;await async function(e,t,r){console.debug("Executing cell, expressions",c(t));const n=r.find((t=>t.content===e)),s=null==n?void 0:n.sessionContext;if(void 0===s)return;if(!function(e){return"markdown"===e.model.type}(t))return;console.debug(`Markdown cell ${t.model.id} was executed`),await t.updateFragmentMDAST();const o=await async function(e,t){var r,n,s;const o=null===(r=t.session)||void 0===r?void 0:r.kernel;if(!o)throw new Error("Session has no kernel.");const a=null!==(s=null===(n=e.mystModel)||void 0===n?void 0:n.mdast)&&void 0!==s?s:{},i=(0,A.td)("inlineExpression",a).map((e=>e.value)),d=new Map(i.map(((e,t)=>[`${t}`,e])));if(console.debug("Executing named expressions",d),0==d.size)return Promise.resolve([]);const l={};d.forEach(((e,t)=>{l[t]=e}));const c={code:"",user_expressions:l};return new Promise(((e,t)=>{console.debug("Performing kernel request",c),o.requestExecute(c,!1).onReply=r=>{console.debug("Handling kernel response",r);const n=r.content;if("ok"!==n.status)return t("Kernel response was not OK");const s=[];for(const e in n.user_expressions){const r=d.get(e);if(void 0===r)return t("namedExpressions doesn't have key. This should never happen");const o={expression:r,result:n.user_expressions[e]};s.push(o)}return e(s)}}))}(t,s);console.debug("Handling evaluated user expressions",o),o.length?(console.debug("Setting metadata, before:",c(t),"after:",o),function(e,t){e&&(e.model.setMetadata?e.model.setMetadata(l,t):e.model.metadata.set(l,t))}(t,o)):function(e){e&&(e.model.setMetadata?e.model.deleteMetadata(l):e.model.metadata.delete(l))}(t),t.model.trusted=!0}(n,s,t)}))}},{id:"jupyterlab-myst:mime-renderer",requires:[ee.IRenderMimeRegistry],autoStart:!0,optional:[n.IMarkdownViewerTracker],activate:(e,t,r)=>{console.log("Using jupyterlab-myst:mime-renderer"),t.addFactory(ne)}}]},44692:(e,t,r)=>{var n,s,o;r.d(t,{Ft:()=>o}),function(e){e.Article="Article",e.Notebook="Notebook"}(n||(n={})),function(e){e.content="notebook-content",e.code="notebook-code"}(s||(s={})),function(e){e.string="string",e.number="number",e.boolean="boolean",e.parsed="parsed"}(o||(o={}))}}]);